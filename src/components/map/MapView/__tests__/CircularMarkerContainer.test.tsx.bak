/* @vitest-environment jsdom */
import type { MapPoint } from "@/types";
import { fireEvent, render, screen, within } from "@testing-library/react";
import { describe, expect, it, vi } from "vitest";
import { CircularMarkerContainer } from "../CircularMarkerContainer";

// react-google-maps モック
vi.mock("@vis.gl/react-google-maps", () => ({
  AdvancedMarker: ({ children, onClick }: any) => (
    <span
      data-testid="advanced-marker"
      onClick={onClick}
      style={{ display: "inline-block" }}
    >
      {children}
    </span>
  ),
  InfoWindow: ({ children, onCloseClick }: any) => (
    <div role="dialog">
      <button onClick={onCloseClick} aria-label="Close info window">
        ×
      </button>
      {children}
    </div>
  ),
}));

// CircularMarker は実際のコンポーネントを使用（モックしない）
// 理由: レンダリング、スタイル、アクセシビリティの検証が必要なため

// MapInfoWindow モック
vi.mock("./MapInfoWindow", () => ({
  MapInfoWindow: ({ point }: any) => (
    <div data-testid="map-info-window">
      <h3>{point.name}</h3>
      <p>{point.type}</p>
    </div>
  ),
}));

// テストデータ
const restaurantPoint: MapPoint = {
  id: "rest-1",
  type: "restaurant",
  name: "テストレストラン",
  district: "両津" as any,
  address: "佐渡市両津1-1",
  coordinates: { lat: 38.0, lng: 138.4 },
  features: ["駐車場あり"],
  lastUpdated: new Date().toISOString(),
  cuisineType: "日本料理",
  priceRange: "¥¥",
};

const parkingPoint: MapPoint = {
  id: "park-1",
  type: "parking",
  name: "テスト駐車場",
  district: "佐和田" as any,
  address: "佐渡市佐和田2-2",
  coordinates: { lat: 38.1, lng: 138.5 },
  features: ["24時間"],
  lastUpdated: new Date().toISOString(),
  capacity: 50,
  fee: "無料",
};

const toiletPoint: MapPoint = {
  id: "toilet-1",
  type: "toilet",
  name: "テストトイレ",
  district: "金井" as any,
  address: "佐渡市金井3-3",
  coordinates: { lat: 38.2, lng: 138.6 },
  features: ["多目的"],
  lastUpdated: new Date().toISOString(),
  isMultipurpose: true,
  hasOstomate: false,
};

describe("CircularMarkerContainer", () => {
  describe("基本レンダリング", () => {
    it("空配列でもエラーなくレンダリングできる", () => {
      const { container } = render(<CircularMarkerContainer points={[]} />);
      expect(container).toBeInTheDocument();
    });

    it("レストランマーカーが正しくレンダリングされる", () => {
      render(<CircularMarkerContainer points={[restaurantPoint]} />);
      const marker = screen.getByRole("button", {
        name: /テストレストラン/,
      });
      expect(marker).toBeInTheDocument();
      expect(marker).toHaveClass("circular-marker");
    });

    it("駐車場マーカーが正しくレンダリングされる", () => {
      render(<CircularMarkerContainer points={[parkingPoint]} />);
      const marker = screen.getByRole("button", {
        name: /駐車場: テスト駐車場/,
      });
      expect(marker).toBeInTheDocument();
      expect(marker).toHaveClass("parking-marker");
    });

    it("トイレマーカーが正しくレンダリングされる", () => {
      render(<CircularMarkerContainer points={[toiletPoint]} />);
      const marker = screen.getByRole("button", {
        name: /トイレ: テストトイレ/,
      });
      expect(marker).toBeInTheDocument();
      expect(marker).toHaveClass("circular-marker");
    });

    it("複数のマーカーを同時にレンダリングできる", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint, parkingPoint, toiletPoint]}
        />
      );
      expect(
        screen.getByRole("button", { name: /テストレストラン/ })
      ).toBeInTheDocument();
      expect(
        screen.getByRole("button", { name: /駐車場: テスト駐車場/ })
      ).toBeInTheDocument();
      expect(
        screen.getByRole("button", { name: /トイレ: テストトイレ/ })
      ).toBeInTheDocument();
    });
  });

  describe("マーカーサイズ", () => {
    it("デフォルトでmediumサイズが適用される", () => {
      render(<CircularMarkerContainer points={[restaurantPoint]} />);
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-size", "medium");
    });

    it("smallサイズが適用される", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint]}
          markerSize="small"
        />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-size", "small");
    });

    it("largeサイズが適用される", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint]}
          markerSize="large"
        />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-size", "large");
    });

    it("xlargeサイズが適用される", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint]}
          markerSize="xlarge"
        />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-size", "xlarge");
    });
  });

  describe("フィルタリング", () => {
    it("デフォルトで全タイプのマーカーが表示される", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint, parkingPoint, toiletPoint]}
        />
      );
      expect(screen.getAllByTestId("circular-marker")).toHaveLength(3);
    });

    it("レストランのみフィルタリングできる", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint, parkingPoint, toiletPoint]}
          visibleTypes={["restaurant"]}
        />
      );
      expect(screen.getAllByTestId("circular-marker")).toHaveLength(1);
      expect(
        screen.getByRole("button", { name: /テストレストラン/ })
      ).toBeInTheDocument();
    });

    it("駐車場のみフィルタリングできる", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint, parkingPoint, toiletPoint]}
          visibleTypes={["parking"]}
        />
      );
      expect(screen.getAllByTestId("circular-marker")).toHaveLength(1);
      expect(
        screen.getByRole("button", { name: /駐車場/ })
      ).toBeInTheDocument();
    });

    it("複数タイプを同時にフィルタリングできる", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint, parkingPoint, toiletPoint]}
          visibleTypes={["restaurant", "parking"]}
        />
      );
      expect(screen.getAllByTestId("circular-marker")).toHaveLength(2);
    });

    it("空のフィルタで何も表示されない", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint, parkingPoint, toiletPoint]}
          visibleTypes={[]}
        />
      );
      expect(screen.queryAllByTestId("circular-marker")).toHaveLength(0);
    });
  });

  describe("クリックイベント", () => {
    it("マーカークリック時にonPointClickが呼ばれる", () => {
      const handleClick = vi.fn();
      render(
        <CircularMarkerContainer
          points={[restaurantPoint]}
          onPointClick={handleClick}
        />
      );

      const marker = screen.getByRole("button", {
        name: /テストレストラン/,
      });
      fireEvent.click(marker);

      expect(handleClick).toHaveBeenCalledTimes(1);
      expect(handleClick).toHaveBeenCalledWith(restaurantPoint);
    });

    it("onPointClickが未指定でもエラーにならない", () => {
      render(<CircularMarkerContainer points={[restaurantPoint]} />);

      const marker = screen.getByRole("button", {
        name: /テストレストラン/,
      });
      expect(() => fireEvent.click(marker)).not.toThrow();
    });

    it("複数マーカーのクリックをそれぞれ正しく処理する", () => {
      const handleClick = vi.fn();
      render(
        <CircularMarkerContainer
          points={[restaurantPoint, parkingPoint]}
          onPointClick={handleClick}
        />
      );

      const restaurantMarker = screen.getByRole("button", {
        name: /テストレストラン/,
      });
      const parkingMarker = screen.getByRole("button", {
        name: /駐車場/,
      });

      fireEvent.click(restaurantMarker);
      expect(handleClick).toHaveBeenLastCalledWith(restaurantPoint);

      fireEvent.click(parkingMarker);
      expect(handleClick).toHaveBeenLastCalledWith(parkingPoint);

      expect(handleClick).toHaveBeenCalledTimes(2);
    });
  });

  describe("InfoWindow", () => {
    it("showInfoWindowがfalseの場合、InfoWindowは表示されない", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint]}
          selectedPoint={restaurantPoint}
          showInfoWindow={false}
        />
      );
      expect(screen.queryByRole("dialog")).not.toBeInTheDocument();
    });

    it("showInfoWindowがtrueでselectedPointがある場合、InfoWindowが表示される", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint]}
          selectedPoint={restaurantPoint}
          showInfoWindow={true}
        />
      );
      const dialog = screen.getByRole("dialog");
      expect(dialog).toBeInTheDocument();
      expect(within(dialog).getByText("テストレストラン")).toBeInTheDocument();
    });

    it("selectedPointがnullの場合、InfoWindowは表示されない", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint]}
          selectedPoint={null}
          showInfoWindow={true}
        />
      );
      expect(screen.queryByRole("dialog")).not.toBeInTheDocument();
    });

    it("InfoWindow閉じるボタンでonInfoWindowCloseが呼ばれる", () => {
      const handleClose = vi.fn();
      render(
        <CircularMarkerContainer
          points={[restaurantPoint]}
          selectedPoint={restaurantPoint}
          showInfoWindow={true}
          onInfoWindowClose={handleClose}
        />
      );

      const closeButton = screen.getByRole("button", {
        name: /Close info window/,
      });
      fireEvent.click(closeButton);

      expect(handleClose).toHaveBeenCalledTimes(1);
    });

    it("onInfoWindowCloseが未指定でもエラーにならない", () => {
      render(
        <CircularMarkerContainer
          points={[restaurantPoint]}
          selectedPoint={restaurantPoint}
          showInfoWindow={true}
        />
      );

      const closeButton = screen.getByRole("button", {
        name: /Close info window/,
      });
      expect(() => fireEvent.click(closeButton)).not.toThrow();
    });
  });

  describe("料理タイプマッピング", () => {
    const createRestaurant = (cuisineType: string): MapPoint => ({
      ...restaurantPoint,
      id: `rest-${cuisineType}`,
      cuisineType,
    });

    it("日本料理がjapaneseカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer points={[createRestaurant("日本料理")]} />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "japanese");
    });

    it("寿司がjapaneseカテゴリにマッピングされる", () => {
      render(<CircularMarkerContainer points={[createRestaurant("寿司")]} />);
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "japanese");
    });

    it("ラーメンがnoodlesカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer points={[createRestaurant("ラーメン")]} />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "noodles");
    });

    it("そば・うどんがnoodlesカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer points={[createRestaurant("そば・うどん")]} />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "noodles");
    });

    it("焼肉・焼鳥がyakinikuカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer points={[createRestaurant("焼肉・焼鳥")]} />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "yakiniku");
    });

    it("ステーキ・洋食がyakinikuカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer
          points={[createRestaurant("ステーキ・洋食")]}
        />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "yakiniku");
    });

    it("中華がinternationalカテゴリにマッピングされる", () => {
      render(<CircularMarkerContainer points={[createRestaurant("中華")]} />);
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "international");
    });

    it("イタリアンがinternationalカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer points={[createRestaurant("イタリアン")]} />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "international");
    });

    it("カフェ・喫茶店がcafeカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer
          points={[createRestaurant("カフェ・喫茶店")]}
        />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "cafe");
    });

    it("バー・居酒屋がizakayaカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer points={[createRestaurant("バー・居酒屋")]} />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "izakaya");
    });

    it("ファストフードがfastfoodカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer
          points={[createRestaurant("ファストフード")]}
        />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "fastfood");
    });

    it("未知の料理タイプがgeneralカテゴリにマッピングされる", () => {
      render(
        <CircularMarkerContainer points={[createRestaurant("未知の料理")]} />
      );
      const marker = screen.getByTestId("circular-marker");
      expect(marker).toHaveAttribute("data-category", "general");
    });
  });

  describe("アクセシビリティ", () => {
    it("レストランマーカーに適切なaria-labelが設定される", () => {
      render(<CircularMarkerContainer points={[restaurantPoint]} />);
      const marker = screen.getByRole("button", {
        name: "テストレストラン - 日本料理",
      });
      expect(marker).toBeInTheDocument();
    });

    it("駐車場マーカーに適切なaria-labelが設定される", () => {
      render(<CircularMarkerContainer points={[parkingPoint]} />);
      const marker = screen.getByRole("button", {
        name: "駐車場: テスト駐車場",
      });
      expect(marker).toBeInTheDocument();
    });

    it("トイレマーカーに適切なaria-labelが設定される", () => {
      render(<CircularMarkerContainer points={[toiletPoint]} />);
      const marker = screen.getByRole("button", {
        name: "トイレ: テストトイレ",
      });
      expect(marker).toBeInTheDocument();
    });
  });

  describe("DEV環境でのデバッグログ", () => {
    it("開発環境でマーカークリック時にconsole.debugが呼ばれる", () => {
      const originalEnv = import.meta.env.DEV;
      (import.meta.env as any).DEV = true;
      const consoleSpy = vi.spyOn(console, "debug").mockImplementation();

      render(
        <CircularMarkerContainer
          points={[parkingPoint]}
          onPointClick={vi.fn()}
        />
      );

      const marker = screen.getByRole("button", { name: /駐車場/ });
      fireEvent.click(marker);

      expect(consoleSpy).toHaveBeenCalledWith(
        "[CircularMarkerContainer] marker click",
        {
          id: "park-1",
          type: "parking",
          name: "テスト駐車場",
        }
      );

      consoleSpy.mockRestore();
      (import.meta.env as any).DEV = originalEnv;
    });
  });

  describe("重複キー回避", () => {
    it("同じIDでも異なるtypeの場合、重複キーエラーが発生しない", () => {
      const duplicateIdPoints: MapPoint[] = [
        { ...restaurantPoint, id: "duplicate-1" },
        { ...parkingPoint, id: "duplicate-1" },
      ];

      // エラーなくレンダリングできることを確認
      const { container } = render(
        <CircularMarkerContainer points={duplicateIdPoints} />
      );
      expect(container).toBeInTheDocument();
      expect(screen.getAllByTestId("circular-marker")).toHaveLength(2);
    });
  });
});
