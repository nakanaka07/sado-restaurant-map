name: Lighthouse CI

on:
  workflow_run:
    workflows: [CI]
    types: [completed]

jobs:
  lhci:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Download dist artifacts from CI
        uses: actions/download-artifact@v4
        with:
          name: dist-build
          path: dist
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify dist exists
        run: |
          if [ ! -d "dist" ] || [ -z "$(ls -A dist)" ]; then
            echo "Error: dist directory is empty or missing"
            exit 1
          fi
          echo "dist/ contents verified"
          ls -lh dist/ | head -20

      - name: Run Lighthouse CI
        run: npx lhci autorun --config=lighthouserc.json || echo "LHCI finished with non-zero exit (soft fail)"

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci
          if-no-files-found: ignore
          retention-days: 3

      - name: Extract Lighthouse scores
        id: scores
        run: |
          if [ ! -f ".lighthouseci/manifest.json" ]; then
            echo "Manifest missing";
            exit 0;
          fi
          node scripts/ci/lighthouse-scores.cjs || echo "Score extraction failed"
          if [ -f lh-scores.json ]; then
            echo "perf=$(jq '.performance' lh-scores.json)" >> $GITHUB_OUTPUT
            echo "acc=$(jq '.accessibility' lh-scores.json)" >> $GITHUB_OUTPUT
          fi

      - name: Post PR comment (if applicable)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
        run: |
          set -e
          resp=$(curl -s -H "Authorization: Bearer $GH_TOKEN" -H 'Accept: application/vnd.github+json' https://api.github.com/repos/$REPO/commits/$HEAD_SHA/pulls)
          pr=$(echo "$resp" | jq -r '.[0].number // empty')
          if [ -z "$pr" ]; then echo "No PR found for head sha"; exit 0; fi
          scores=$(cat lh-scores.json | jq -r '. | to_entries | map("| " + .key + " | " + (.value|tostring) + "% |") | join("\n")')
          body="<!--lhci-report-->\n### Lighthouse Scores\n| Category | Score |\n|----------|-------|\n${scores}\n"
          curl -s -X POST -H "Authorization: Bearer $GH_TOKEN" -H 'Accept: application/vnd.github+json' -d "$(jq -nc --arg body "$body" '{body:$body}')" https://api.github.com/repos/$REPO/issues/$pr/comments > /dev/null || echo 'Comment failed'

      - name: Summary
        run: |
          echo "Lighthouse CI run completed" >> $GITHUB_STEP_SUMMARY
          echo "Scores: Performance=${{ steps.scores.outputs.perf }}%, Accessibility=${{ steps.scores.outputs.acc }}%" >> $GITHUB_STEP_SUMMARY
          echo "Thresholds are enforced by lighthouserc.json assertions (Performance ≥90%, Accessibility ≥95%)" >> $GITHUB_STEP_SUMMARY

      - name: Persist Lighthouse scores (main only)
        if: github.ref == 'refs/heads/main' && steps.scores.outputs.perf != ''
        run: |
          if [ -f lh-scores.json ]; then
            mkdir -p metrics/lighthouse
            ts=$(date -u +%Y%m%dT%H%M%SZ)
            cp lh-scores.json metrics/lighthouse/$ts.json
            git config user.name 'github-actions'
            git config user.email 'actions@github.com'
            git add metrics/lighthouse/$ts.json || true
            git commit -m "chore: add lighthouse score $ts [skip ci]" || echo 'No diff to commit'
            git push || echo 'Push failed (permissions?)'
          else
            echo 'lh-scores.json missing; skip persistence'
          fi
