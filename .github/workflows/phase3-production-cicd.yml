# Phase 3-Full CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ - Dockerç’°å¢ƒã§ã®ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè‡ªå‹•åŒ–

name: Phase3 Production CI/CD

on:
  push:
    branches: [main, develop, feature/phase3-*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤å¯¾è±¡ç’°å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      deployment_strategy:
        description: "ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥"
        required: true
        default: "blue-green"
        type: choice
        options:
          - blue-green
          - canary
          - rolling

permissions:
  contents: read
  packages: write
  security-events: write
  actions: read

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  NODE_VERSION: 22
  PYTHON_VERSION: 3.12

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===== ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¨ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ =====
  setup-and-validate:
    name: ğŸ”§ ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      cache-node-key: ${{ steps.node-cache.outputs.cache-hit }}
      cache-python-key: ${{ steps.python-cache.outputs.cache-hit }}
      should-deploy: ${{ steps.deploy-check.outputs.should-deploy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Node.js ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        id: node-cache
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Python ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        id: python-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          # Node.js ä¾å­˜é–¢ä¿‚
          pnpm config set registry https://registry.npmjs.org
          pnpm config set fetch-retries 5
          pnpm install --frozen-lockfile

          # Python ä¾å­˜é–¢ä¿‚
          pip install --upgrade pip
          pip install -r requirements-test.txt

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤å¿…è¦æ€§ãƒã‚§ãƒƒã‚¯
        id: deploy-check
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  # ===== ä¸¦åˆ—å“è³ªãƒã‚§ãƒƒã‚¯ =====
  code-quality:
    name: ğŸ“Š ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    needs: setup-and-validate
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        check-type:
          - linting
          - formatting
          - complexity
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ä¾å­˜é–¢ä¿‚å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: pnpm install --frozen-lockfile

      - name: ESLint ãƒã‚§ãƒƒã‚¯
        if: matrix.check-type == 'linting'
        run: |
          pnpm run lint
          pnpm run typecheck

      - name: Markdownlint ãƒã‚§ãƒƒã‚¯
        if: matrix.check-type == 'formatting'
        run: pnpm run lint:md

      - name: è¤‡é›‘åº¦åˆ†æ
        if: matrix.check-type == 'complexity'
        run: |
          pnpm run analyze:deps
          pnpm run analyze:coupling

  security-scan:
    name: ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
    runs-on: ubuntu-latest
    needs: setup-and-validate
    timeout-minutes: 25
    strategy:
      fail-fast: false
      matrix:
        scan-type:
          - dependencies
          - code-security
          - docker-security
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node.js ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
        if: matrix.scan-type == 'dependencies'
        run: |
          npm audit --audit-level=moderate
          pnpm audit --audit-level=moderate

      - name: Python ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ (Bandit)
        if: matrix.scan-type == 'code-security'
        run: |
          pip install bandit[toml]
          bandit -r tools/scraper -f json -o bandit-report.json || true
          bandit -r tools/scraper --severity-level medium

      - name: Docker ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³
        if: matrix.scan-type == 'docker-security'
        uses: docker/scout-action@v1
        with:
          command: cves
          image: local://phase3-app
          only-severities: critical,high,medium
          exit-code: true

  # ===== ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ =====
  unit-tests:
    name: ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: setup-and-validate
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - frontend
          - backend
          - integration
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Python ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: pnpm ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ä¾å­˜é–¢ä¿‚å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/.local/share/pnpm/store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: |
          pnpm install --frozen-lockfile
          pip install -r requirements-test.txt

      - name: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
        if: matrix.test-suite == 'frontend'
        run: |
          pnpm run test:coverage
        env:
          VITE_GOOGLE_MAPS_API_KEY: test-key
          VITE_GOOGLE_MAPS_MAP_ID: test-map-id

      - name: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
        if: matrix.test-suite == 'backend'
        run: |
          cd tools/scraper
          python -m pytest tests/ -v --cov=. --cov-report=xml

      - name: çµ±åˆãƒ†ã‚¹ãƒˆ
        if: matrix.test-suite == 'integration'
        run: pnpm run integration:test

      - name: ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info,./tools/scraper/coverage.xml
          fail_ci_if_error: false

  # ===== SonarQube å“è³ªåˆ†æ =====
  sonarqube-analysis:
    name: ğŸ“ˆ SonarQube å“è³ªåˆ†æ
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, unit-tests]
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: SonarQube ã‚¹ã‚­ãƒ£ãƒ³
        uses: sonarqube-quality-gate-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN || 'dummy-token' }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL || 'http://localhost:9000' }}

      - name: å“è³ªã‚²ãƒ¼ãƒˆç¢ºèª
        run: |
          echo "SonarQubeå“è³ªã‚²ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯å®Œäº†"

  # ===== Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ =====
  docker-build:
    name: ğŸ³ Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
    runs-on: ubuntu-latest
    needs: [sonarqube-analysis]
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: app
            dockerfile: Dockerfile.app
          - image: worker
            dockerfile: Dockerfile.worker
          - image: test
            dockerfile: Dockerfile.test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker Buildx ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: docker/setup-buildx-action@v3

      - name: ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ­ã‚°ã‚¤ãƒ³
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.image }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ—ãƒƒã‚·ãƒ¥
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # ===== Phase3 çµ±åˆãƒ†ã‚¹ãƒˆ =====
  integration-tests:
    name: ğŸ”„ Phase3 çµ±åˆãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    needs: docker-build
    timeout-minutes: 60
    services:
      redis-master-1:
        image: redis:7-alpine
        ports:
          - 7001:7001
        options: >-
          --health-cmd "redis-cli -p 7001 ping"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 3
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Phase3 ç’°å¢ƒèµ·å‹•
        run: |
          docker-compose -f docker-compose.phase3.yml up -d
          sleep 60  # ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¾…æ©Ÿ

      - name: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
        run: |
          ./tools/testing/health-check.sh

      - name: Redis ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ ãƒ†ã‚¹ãƒˆ
        run: |
          python test_distributed_processing.py

      - name: è² è·ãƒ†ã‚¹ãƒˆ
        run: |
          ./tools/testing/load-test.sh

      - name: ãƒ­ã‚°åé›†
        if: always()
        run: |
          docker-compose -f docker-compose.phase3.yml logs > integration-logs.txt

      - name: ç’°å¢ƒã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          docker-compose -f docker-compose.phase3.yml down -v

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: |
            integration-logs.txt
            ml_engine_integration_test_result.json

  # ===== ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ (æœ¬ç•ªç’°å¢ƒ) =====
  deploy-production:
    name: ğŸš€ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
    runs-on: ubuntu-latest
    needs: [integration-tests]
    if: github.ref == 'refs/heads/main'
    timeout-minutes: 30
    strategy:
      matrix:
        deployment-strategy:
          - blue-green
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: ãƒ–ãƒ«ãƒ¼ãƒ»ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
        if: matrix.deployment-strategy == 'blue-green'
        run: |
          echo "ğŸ”µ ãƒ–ãƒ«ãƒ¼ãƒ»ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œä¸­..."
          # ./tools/deployment/blue-green-deploy.sh

      - name: ã‚«ãƒŠãƒªã‚¢ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
        if: github.event.inputs.deployment_strategy == 'canary'
        run: |
          echo "ğŸ¤ ã‚«ãƒŠãƒªã‚¢ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œä¸­..."
          # ./tools/deployment/canary-deploy.sh

      - name: ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ
        if: github.event.inputs.deployment_strategy == 'rolling'
        run: |
          echo "ğŸ”„ ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œä¸­..."
          # ./tools/deployment/rolling-deploy.sh

      - name: ãƒã‚¹ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼
        run: |
          echo "âœ… ãƒã‚¹ãƒˆãƒ‡ãƒ—ãƒ­ã‚¤æ¤œè¨¼å®Ÿè¡Œä¸­..."
          # ./tools/deployment/post-deploy-validation.sh

      - name: Slacké€šçŸ¥
        if: always()
        run: |
          echo "ğŸ“¢ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆé€šçŸ¥: ${{ job.status }}"

  # ===== ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š =====
  setup-monitoring:
    name: ğŸ“Š ç›£è¦–ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    runs-on: ubuntu-latest
    needs: [deploy-production]
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prometheusè¨­å®šæ›´æ–°
        run: |
          ./tools/monitoring/update-prometheus-config.sh

      - name: Grafanaãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
        run: |
          ./tools/monitoring/update-grafana-dashboards.sh

      - name: ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
        run: |
          ./tools/monitoring/configure-alerts.sh

      - name: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ç›£è¦–é–‹å§‹
        run: |
          ./tools/monitoring/start-health-monitoring.sh
