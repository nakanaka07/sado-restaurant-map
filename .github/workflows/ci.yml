name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write # size baseline 更新でコミットするため

jobs:
  build-test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        uses: ./.github/actions/setup-env

      - name: Lint
        run: pnpm lint

      - name: Type Check
        run: pnpm type-check

      - name: Tests
        run: pnpm test:run

      - name: Coverage (upload summary)
        run: |
          pnpm test:coverage
          if [ -f coverage/coverage-summary.json ]; then
            lines=$(jq '.total.lines.pct' coverage/coverage-summary.json || echo 0)
            echo "Lines Coverage: ${lines}%" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Enforce coverage threshold (>=65%)
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            pct=$(jq '.total.lines.pct' coverage/coverage-summary.json || echo 0)
            echo "Detected coverage lines pct=${pct}%" >> $GITHUB_STEP_SUMMARY
            echo "Coverage threshold: 65% (current ~71%)" >> $GITHUB_STEP_SUMMARY

            # Use bc for reliable floating point comparison
            if command -v bc >/dev/null 2>&1; then
              if (( $(echo "${pct} >= 65" | bc -l) )); then
                echo "✅ Coverage ${pct}% meets 65% threshold"
              else
                echo "❌ Coverage ${pct}% < 65% threshold" >&2
                exit 1
              fi
            else
              # Fallback: Use awk with proper variable substitution
              result=$(awk -v pct="$pct" 'BEGIN { print (pct >= 65) ? "pass" : "fail" }')
              if [ "$result" = "pass" ]; then
                echo "✅ Coverage ${pct}% meets 65% threshold"
              else
                echo "❌ Coverage ${pct}% < 65% threshold" >&2
                exit 1
              fi
            fi
          else
            echo "coverage-summary.json not found" >&2; exit 1
          fi

      - name: Upload coverage summary artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-summary
          path: coverage/coverage-summary.json
          if-no-files-found: ignore
          retention-days: 1

      - name: Artifact coverage html
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-html
          path: coverage
          if-no-files-found: ignore

      - name: Production build with analysis
        env:
          ANALYZE: true
          VITE_GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          VITE_GOOGLE_MAPS_MAP_ID: ${{ secrets.GOOGLE_MAPS_MAP_ID }}
          VITE_GOOGLE_SHEETS_API_KEY: ${{ secrets.GOOGLE_SHEETS_API_KEY }}
          VITE_SPREADSHEET_ID: ${{ secrets.SPREADSHEET_ID }}
          VITE_GA_MEASUREMENT_ID: ${{ secrets.GA_MEASUREMENT_ID }}
        run: pnpm build

      - name: Run size-limit (json)
        run: |
          # Use npx to bypass pnpm script banner so output is pure JSON
          npx --no-install size-limit --json > size-limit.json.tmp 2>/dev/null || echo "size-limit exited non-zero (continuing)"
          # Validate JSON (basic) and move
          if jq -e . size-limit.json.tmp >/dev/null 2>&1; then
            mv size-limit.json.tmp size-limit.json
          else
            echo '{}' > size-limit.json
            echo '::warning:: size-limit did not produce valid JSON; using empty object'
          fi

      - name: Bundle stats summary
        run: |
          if [ -f size-limit.json ]; then
            echo "### Bundle Size Report" >> $GITHUB_STEP_SUMMARY
            echo '' >> $GITHUB_STEP_SUMMARY
            node scripts/ci/bundle-stats.cjs >> $GITHUB_STEP_SUMMARY
          else
            echo "size-limit.json not found" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload dist artifacts (for reuse)
        uses: actions/upload-artifact@v4
        with:
          name: dist-build
          path: dist
          if-no-files-found: error
          retention-days: 1

      - name: Upload bundle stats
        uses: actions/upload-artifact@v4
        with:
          name: bundle-stats
          path: dist/stats.html
          if-no-files-found: ignore
          retention-days: 3

      - name: Compare bundle against baseline
        id: size-diff
        run: |
          BASE_FILE=metrics/size-limit.json
          if [ -f size-limit.json ] && [ -f "$BASE_FILE" ]; then
            echo "Baseline exists. Computing diff..."
            node scripts/ci/bundle-diff.cjs || echo "Bundle diff calculation failed"
            echo "diff_done=true" >> $GITHUB_OUTPUT
          else
            echo "No baseline. Skipping diff."
            echo "diff_done=false" >> $GITHUB_OUTPUT
          fi
      - name: Upload size diff artifact
        if: steps.size-diff.outputs.diff_done == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: size-diff
          path: size-diff.json
          if-no-files-found: ignore

      - name: Update size baseline (main only)
        if: github.ref == 'refs/heads/main'
        run: |
          if [ -f size-limit.json ]; then
            mkdir -p metrics
            cp size-limit.json metrics/size-limit.json
            git config user.name 'github-actions'
            git config user.email 'actions@github.com'
            if git diff --quiet -- metrics/size-limit.json; then
              echo 'Baseline unchanged'
            else
              git add metrics/size-limit.json
              git commit -m 'chore: update size baseline'
              git push || echo 'Baseline push failed (possibly no permissions)'
            fi
          fi

      - name: Record start time (already implicit) & Emit job duration
        if: always()
        run: |
          echo "Job completed at $(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY
          echo "(GitHub UI shows per-step timing; fine-grained metrics can be added later.)" >> $GITHUB_STEP_SUMMARY
